<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gallery â€” Photo Booth</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“¸</text></svg>">
  <style>
    #splashScreen{position:fixed;inset:0;z-index:9999;background:#0C0C18;display:flex;align-items:center;justify-content:center;transition:opacity .35s ease}
    .splash-inner{text-align:center;display:flex;flex-direction:column;align-items:center;gap:12px}
    .splash-emoji{font-size:56px;animation:sp 1.5s ease-in-out infinite}
    .splash-title{font-family:Georgia,serif;font-size:1.5rem;font-weight:700;background:linear-gradient(135deg,#B4A7FF,#FF6B9D);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .splash-spinner{width:28px;height:28px;border:3px solid #28284A;border-top-color:#FF6B9D;border-radius:50%;animation:spin .8s linear infinite;margin-top:8px}
    @keyframes sp{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.7;transform:scale(1.05)}}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
  <link rel="stylesheet" href="../style.css">
  <script src="https://www.google.com/recaptcha/api.js?render=6Ld0RWgsAAAAABRdIcHVQcVkgAswfd_wb4mluzfY"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@4/dist/fp.min.js"></script>
  <script>var PAGE_TYPE = 'private';</script>
</head>
<body>

  <div id="splashScreen"><div class="splash-inner"><div class="splash-emoji">ðŸ“¸</div><h1 class="splash-title">Photo Booth</h1><div class="splash-spinner"></div></div></div>

  <div id="pageContent" style="display:none;">
    <header class="app-header">
      <div class="header-left">
        <a href="../" class="back-link"><span class="material-icons-round">arrow_back</span></a>
        <span class="material-icons-round logo-icon">photo_camera</span>
        <h1>Gallery</h1>
      </div>
      <div class="header-right">
        <button class="icon-btn" onclick="handleLogout()" title="Sign Out"><span class="material-icons-round">logout</span></button>
      </div>
    </header>

    <main class="main-content">
      <!-- Gallery Stats -->
      <div class="gallery-header">
        <div class="gallery-stats">
          <span class="material-icons-round">photo_library</span>
          <span id="galleryCount">Loading...</span>
        </div>
      </div>

      <!-- Loading -->
      <div class="gallery-loading" id="galleryLoading">
        <div class="splash-spinner" style="margin:40px auto;"></div>
        <p style="text-align:center;color:#8585A8;">Loading gallery...</p>
      </div>

      <!-- Empty state -->
      <div class="gallery-empty" id="galleryEmpty" style="display:none;">
        <span class="material-icons-round" style="font-size:64px;color:#28284A;">photo_library</span>
        <h3>No photos yet</h3>
        <p>Photos will appear here after they're captured and approved.</p>
        <a href="../" class="btn btn-primary"><span class="material-icons-round">camera</span> Take Photos</a>
      </div>

      <!-- Gallery Grid -->
      <div class="gallery-grid" id="galleryGrid" style="display:none;"></div>
    </main>
  </div>

  <!-- Lightbox -->
  <div class="lightbox" id="lightbox">
    <button class="lightbox-close" onclick="closeLightbox()"><span class="material-icons-round">close</span></button>
    <div class="lightbox-body">
      <img id="lightboxImg" src="" alt="Photo">
    </div>
    <div class="lightbox-actions">
      <button class="btn btn-outline" onclick="downloadLightboxPhoto()"><span class="material-icons-round">download</span> Download</button>
    </div>
    <div class="lightbox-meta" id="lightboxMeta"></div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="../auth.js"></script>

  <script>
    var galleryPhotos = [];
    var currentLightboxIdx = -1;

    function onAuthReady(user) {
      if (!user) return;
      loadGallery();
    }

    function loadGallery() {
      var loadingEl = document.getElementById('galleryLoading');
      var emptyEl = document.getElementById('galleryEmpty');
      var gridEl = document.getElementById('galleryGrid');
      var countEl = document.getElementById('galleryCount');

      // Try Firestore first
      if (db) {
        db.collection('gallery')
          .orderBy('createdAt', 'desc')
          .limit(100)
          .get()
          .then(function(snapshot) {
            galleryPhotos = [];
            snapshot.forEach(function(doc) {
              var data = doc.data();
              data.id = doc.id;
              galleryPhotos.push(data);
            });

            // Merge local gallery entries
            mergeLocalGallery();
            renderGallery(loadingEl, emptyEl, gridEl, countEl);
          })
          .catch(function(err) {
            console.warn('[Gallery] Firestore failed:', err);
            loadLocalGallery();
            renderGallery(loadingEl, emptyEl, gridEl, countEl);
          });
      } else {
        loadLocalGallery();
        renderGallery(loadingEl, emptyEl, gridEl, countEl);
      }
    }

    function loadLocalGallery() {
      try {
        galleryPhotos = JSON.parse(localStorage.getItem('pb_gallery') || '[]');
      } catch (e) {
        galleryPhotos = [];
      }
    }

    function mergeLocalGallery() {
      try {
        var local = JSON.parse(localStorage.getItem('pb_gallery') || '[]');
        // Add local entries that aren't in Firestore
        local.forEach(function(entry) {
          var exists = galleryPhotos.some(function(p) {
            return p.imageData === entry.imageData;
          });
          if (!exists) galleryPhotos.push(entry);
        });
      } catch (e) {}
    }

    function renderGallery(loadingEl, emptyEl, gridEl, countEl) {
      loadingEl.style.display = 'none';

      if (galleryPhotos.length === 0) {
        emptyEl.style.display = 'flex';
        gridEl.style.display = 'none';
        countEl.textContent = '0 photos';
        return;
      }

      countEl.textContent = galleryPhotos.length + ' photo' + (galleryPhotos.length !== 1 ? 's' : '');
      emptyEl.style.display = 'none';
      gridEl.style.display = 'grid';
      gridEl.innerHTML = '';

      galleryPhotos.forEach(function(photo, idx) {
        var card = document.createElement('div');
        card.className = 'gallery-card';
        card.onclick = function() { openLightbox(idx); };

        var date = '';
        if (photo.createdAt) {
          var d = photo.createdAt.toDate ? photo.createdAt.toDate() : new Date(photo.createdAt);
          date = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        card.innerHTML =
          '<div class="gallery-card-img"><img src="' + photo.imageData + '" alt="Photo" loading="lazy"></div>' +
          '<div class="gallery-card-info">' +
            '<span class="gallery-card-user">' + (photo.userName || 'Guest') + '</span>' +
            '<span class="gallery-card-date">' + date + '</span>' +
          '</div>';

        gridEl.appendChild(card);
      });
    }

    // Lightbox
    function openLightbox(idx) {
      currentLightboxIdx = idx;
      var photo = galleryPhotos[idx];
      document.getElementById('lightboxImg').src = photo.imageData;

      var date = '';
      if (photo.createdAt) {
        var d = photo.createdAt.toDate ? photo.createdAt.toDate() : new Date(photo.createdAt);
        date = d.toLocaleString('en-US', { month: 'long', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' });
      }
      document.getElementById('lightboxMeta').innerHTML =
        '<strong>' + (photo.userName || 'Guest') + '</strong>' +
        (photo.eventTitle ? ' &middot; ' + photo.eventTitle : '') +
        (date ? '<br><small>' + date + '</small>' : '');

      document.getElementById('lightbox').classList.add('active');
    }

    function closeLightbox() {
      document.getElementById('lightbox').classList.remove('active');
    }

    function downloadLightboxPhoto() {
      if (currentLightboxIdx < 0) return;
      var photo = galleryPhotos[currentLightboxIdx];
      var link = document.createElement('a');
      link.download = 'photobooth_' + Date.now() + '.png';
      link.href = photo.imageData;
      document.body.appendChild(link); link.click(); document.body.removeChild(link);
    }

    // Keyboard nav
    document.addEventListener('keydown', function(e) {
      if (!document.getElementById('lightbox').classList.contains('active')) return;
      if (e.key === 'Escape') closeLightbox();
    });
  </script>
</body>
</html>
